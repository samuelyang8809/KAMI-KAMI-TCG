<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>é«˜æ¥­é€Ÿè®€å·¥å…· MVP</title>

  <!-- LIFF SDKï¼ˆæ”¾åˆ° LIFF æ‰æœƒæœ‰æ•ˆï¼‰ -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <style>
    :root{
      --bg:#F7F4EE;           /* å¥¶æ²¹ç±³ç™½ */
      --card:#FFFFFF;         /* å¡ç‰‡ç™½ */
      --text:#1F2937;         /* ä¸»æ–‡å­— */
      --muted:#6B7280;        /* æ¬¡æ–‡å­— */

      --brand:#76B39D;        /* é¼ å°¾è‰ç¶ ï¼šä¸»æŒ‰éˆ•/é‡é» */
      --accent:#7AA7C7;       /* éœ§è—ï¼šæ¬¡å¼·èª¿ */
      --ok:#70C9A8;
      --bad:#E07A7A;

      --line:#E7E1D9;         /* é‚Šæ¡† */
      --shadow: 0 10px 24px rgba(31,41,55,.08);
      --radius: 18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, "PingFang TC", "Noto Sans TC", "Microsoft JhengHei", sans-serif;
      background: var(--bg);
      color: var(--text);
    }
    .wrap{max-width:980px; margin:0 auto; padding:18px 14px 90px}
    .topbar{
      position:sticky; top:0; z-index:10;
      background: rgba(247,244,238,.88);
      backdrop-filter: blur(10px);
      border-bottom:1px solid var(--line);
      padding:12px 14px;
    }
    .topbar .row{max-width:980px;margin:0 auto; display:flex; gap:10px; align-items:center; justify-content:space-between;}
    .brand{
      display:flex; flex-direction:column; line-height:1.2;
    }
    .brand b{font-size:14px}
    .brand span{font-size:12px; color:var(--muted)}
    .pill{
      display:inline-flex; gap:8px; align-items:center;
      padding:8px 10px;
      background: rgba(255,255,255,.85);
      border:1px solid var(--line);
      border-radius:999px;
      color: var(--muted);
      font-size:12px;
    }
    .grid{
      margin-top:14px;
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
    }
    @media (min-width: 860px){
      .grid{ grid-template-columns: 1.15fr .85fr; gap:14px; }
    }
    .card{
      background: var(--card);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:16px;
    }
    h1{font-size:18px;margin:0 0 8px}
    h2{font-size:14px;margin:0 0 10px;color: var(--text)}
    p{margin:0;color:var(--muted); font-size:13px; line-height:1.5}
    .btnrow{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px}
    button{
      appearance:none; border:0; cursor:pointer;
      padding:12px 14px;
      border-radius: 14px;
      font-weight:700;
      color:#0b1a14;
      background: var(--brand);
      box-shadow: 0 10px 22px rgba(118,179,157,.22);
      transition:.15s transform ease, .15s opacity ease;
    }
    button.secondary{
      background: transparent;
      border:1px solid rgba(122,167,199,.55);
      color: var(--text);
      box-shadow:none;
    }
    button.danger{
      background: transparent;
      border:1px solid rgba(224,122,122,.75);
      color:#7a2b2b;
      box-shadow:none;
    }
    button:active{ transform: translateY(1px); opacity:.92; }
    input{
      width:100%;
      padding:12px 12px;
      background: rgba(255,255,255,.9);
      border:1px solid var(--line);
      border-radius: 14px;
      color: var(--text);
      outline:none;
      font-size:14px;
    }
    .sep{ height:1px; background: var(--line); margin:14px 0; }

    .progressWrap{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; margin-top:10px;
    }
    .bar{
      flex:1;
      height:12px; border-radius:999px;
      background: rgba(255,255,255,.9);
      border:1px solid var(--line);
      overflow:hidden;
    }
    .bar > i{
      display:block; height:100%;
      width:0%;
      background: linear-gradient(90deg, var(--brand), var(--accent));
      border-radius:999px;
      transition: width .25s ease;
    }
    .pct{ font-size:12px; color: var(--muted); min-width:80px; text-align:right; }

    .tag{
      display:inline-block;
      padding:6px 10px;
      border-radius:999px;
      background: rgba(118,179,157,.14);
      border: 1px solid rgba(118,179,157,.35);
      color: var(--text);
      font-size:12px;
      margin-top:8px;
    }

    .q{
      margin-top:10px;
      padding:12px;
      border-radius: 16px;
      background: rgba(255,255,255,.9);
      border: 1px solid var(--line);
    }
    .qTitle{font-weight:800; font-size:14px; margin:0 0 6px}
    .choices{display:grid; gap:8px; margin-top:10px}
    .choice{
      text-align:left;
      padding:10px 12px;
      border-radius: 14px;
      background: rgba(255,255,255,.92);
      border: 1px solid var(--line);
      color: var(--text);
      font-weight:700;
    }
    .choice.ok{ border-color: rgba(112,201,168,.9); background: rgba(112,201,168,.16); }
    .choice.bad{ border-color: rgba(224,122,122,.85); background: rgba(224,122,122,.14); }
    .mini{font-size:12px; color: var(--muted); margin-top:8px}
    .list{display:grid; gap:10px; margin-top:10px}
    .item{
      padding:12px;
      border-radius: 16px;
      background: rgba(255,255,255,.9);
      border: 1px solid var(--line);
    }
    .item b{display:block; font-size:13px; margin-bottom:4px}
    .item .meta{font-size:12px; color:var(--muted)}
    .item .ans{margin-top:8px; font-size:12px; color: var(--text)}
    .hidden{display:none !important;}
    .toast{
      position:fixed; left:50%; transform:translateX(-50%);
      bottom:18px; z-index:99;
      background: rgba(255,255,255,.92);
      border:1px solid var(--line);
      color: var(--text);
      padding:10px 12px;
      border-radius: 14px;
      box-shadow: var(--shadow);
      max-width: 92vw;
      font-size:13px;
      opacity:0; pointer-events:none;
      transition:.2s opacity ease, .2s transform ease;
    }
    .toast.show{ opacity:1; transform:translateX(-50%) translateY(-2px); }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="row">
      <div class="brand">
        <b>é«˜æ¥­é€Ÿè®€å·¥å…· MVP</b>
        <span id="subline">LIFF / localStorage</span>
      </div>
      <div class="pill" id="userPill">æœªç™»å…¥</div>
    </div>
  </div>

  <div class="wrap">
    <!-- View: Onboarding -->
    <section class="card" id="viewOnboarding">
      <h1>ç¬¬ä¸€æ¬¡ä½¿ç”¨</h1>
      <p>è«‹å…ˆå¡«å¯«æš±ç¨±ï¼Œæˆ‘å€‘æœƒç”¨ä½ çš„ LINE ä½¿ç”¨è€… ID è¨˜éŒ„é€²åº¦èˆ‡éŒ¯é¡Œæœ¬ã€‚</p>
      <div class="sep"></div>

      <h2>æš±ç¨±</h2>
      <input id="nicknameInput" placeholder="ä¾‹å¦‚ï¼šChenghan / å°æ¥Š / é˜¿å¾·" maxlength="16" />
      <div class="btnrow">
        <button id="btnSaveNickname">é–‹å§‹ä½¿ç”¨</button>
        <button class="secondary" id="btnDemoReset">æ¸…é™¤è³‡æ–™ï¼ˆæ¸¬è©¦ç”¨ï¼‰</button>
      </div>
      <p class="mini">â€» è‹¥åœ¨æœ¬æ©Ÿé–‹å•Ÿï¼Œæœƒä½¿ç”¨ã€Œdemo-userã€ä½œç‚º userIdï¼›æ”¾åˆ° LIFF æ‰æœƒæ‹¿åˆ°çœŸå¯¦ LINE userIdã€‚</p>
    </section>

    <!-- View: Main -->
    <section class="grid hidden" id="viewMain">
      <!-- Left: Dashboard -->
      <div class="card">
        <h1>ä½¿ç”¨è€…ä¸»é </h1>
        <p id="welcomeText">å—¨ï¼</p>

        <div class="progressWrap">
          <div class="bar"><i id="progressBar"></i></div>
          <div class="pct" id="progressText">0%</div>
        </div>
        <div class="tag" id="progressDetail">å·²å®Œæˆ 0 / 0</div>

        <div class="sep"></div>

        <h2>åŠŸèƒ½</h2>
        <div class="btnrow">
          <button id="btnGoSpeedread">é–‹å§‹é€Ÿè®€</button>
          <button class="secondary" id="btnGoWrongbook">éŒ¯é¡Œæœ¬</button>
        </div>

        <div class="sep"></div>

        <h2>ç®¡ç†</h2>
        <div class="btnrow">
          <button class="secondary" id="btnChangeNick">ä¿®æ”¹æš±ç¨±</button>
          <button class="danger" id="btnResetAll">æ¸…é™¤æ‰€æœ‰å­¸ç¿’è³‡æ–™</button>
        </div>

        <p class="mini">MVP å…ˆç”¨ localStorageï¼›ä¸Šç·šæ™‚å†æ›æˆ Firebase/Firestoreã€‚</p>
      </div>

      <!-- Right: Info / Debug -->
      <div class="card">
        <h2>ç›®å‰è³‡æ–™</h2>
        <p class="mini" id="debugInfo">-</p>
        <div class="sep"></div>
        <h2>é€Ÿè®€å…§å®¹ï¼ˆç¤ºç¯„ï¼‰</h2>
        <p>é€™è£¡å…ˆæ”¾ 1 å€‹ç¤ºç¯„å–®å…ƒï¼ˆä½ ä¹‹å¾ŒæŠŠé¡Œåº«æ›æˆä½ çš„ JSON å°±è¡Œï¼‰ã€‚</p>
        <div class="list" id="moduleList"></div>
      </div>
    </section>

    <!-- View: Speedread -->
    <section class="card hidden" id="viewSpeedread">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
        <div>
          <h1 id="srTitle">é€Ÿè®€å·¥å…·</h1>
          <p id="srSub" class="mini">å¿«é€Ÿçœ‹é‡é» â†’ ç«‹åˆ»æª¢æ ¸</p>
        </div>
        <button class="secondary" id="btnBackHome1">å›ä¸»é </button>
      </div>

      <div class="sep"></div>

      <h2>é€Ÿè®€é‡é»</h2>
      <div class="q" id="srKeypoints"></div>

      <div class="sep"></div>

      <h2>å¿«å•å¿«ç­”</h2>
      <div id="questionBox"></div>

      <div class="btnrow">
        <button class="secondary" id="btnNextQuestion">ä¸‹ä¸€é¡Œ</button>
        <button class="secondary" id="btnRestartModule">é‡ä¾†ä¸€æ¬¡</button>
      </div>

      <p class="mini" id="srHint">ç­”éŒ¯æœƒè‡ªå‹•åŠ å…¥éŒ¯é¡Œæœ¬ï¼ˆä¸æœƒå¡é—œï¼‰ã€‚</p>
    </section>

    <!-- View: Wrongbook -->
    <section class="card hidden" id="viewWrongbook">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
        <div>
          <h1>éŒ¯é¡Œæœ¬</h1>
          <p class="mini">é›†ä¸­ç«åŠ›è£œå¼±é»</p>
        </div>
        <button class="secondary" id="btnBackHome2">å›ä¸»é </button>
      </div>

      <div class="sep"></div>

      <div class="btnrow">
        <button class="secondary" id="btnClearWrongbook">æ¸…ç©ºéŒ¯é¡Œæœ¬</button>
      </div>

      <div class="list" id="wrongList"></div>
      <p class="mini" id="wrongEmpty">ç›®å‰æ²’æœ‰éŒ¯é¡Œï¼Œå¤ªå¼·äº† ğŸ˜</p>
    </section>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    /**********************
     * 1) MVP é¡Œåº«ï¼ˆç¤ºç¯„ï¼‰
     * ä¹‹å¾Œä½ å¯ä»¥æŠŠé€™æ®µæ”¹æˆ fetch JSON æª”æˆ–å¾ Firestore è®€
     **********************/
   const MODULES = [
  {
    moduleId: "INVEST-01",
    title: "æŠ•è³‡å­¸ï½œé€Ÿè®€ 5 é¡Œ",
    keypoints: [
      "æŠ•è³‡å­¸é€Ÿè®€é‡é»ï¼šé¢¨éšªâ€”å ±é…¬ã€åˆ†æ•£ã€ç›¸é—œä¿‚æ•¸ã€‚",
      "éç³»çµ±æ€§é¢¨éšªå¯åˆ†æ•£ï¼›ç³»çµ±æ€§é¢¨éšªï¼ˆå¸‚å ´é¢¨éšªï¼‰ä¸å¯åˆ†æ•£ã€‚",
      "ç›¸é—œä¿‚æ•¸è¶Šä½ï¼Œåˆ†æ•£æ•ˆæœé€šå¸¸è¶Šå¥½ã€‚",
      "ï¼ˆMVP ç¤ºç¯„ï¼‰ä¹‹å¾Œå¯æ”¹ç”¨å¤–éƒ¨ JSON é¡Œåº«ã€‚"
    ],
    questions: [
      {
        qid: "INV-01", type: "choice",
        stem: "æŠ•è³‡çµ„åˆç†è«–ä¸­ï¼Œå“ªä¸€ç¨®é¢¨éšªæœ€èƒ½é€éã€åˆ†æ•£æŠ•è³‡ã€é™ä½ï¼Ÿ",
        choices: ["ç³»çµ±æ€§é¢¨éšª", "éç³»çµ±æ€§é¢¨éšª", "é€šè†¨é¢¨éšª", "åˆ©ç‡é¢¨éšª"],
        answerIndex: 1,
        explain: "åˆ†æ•£ä¸»è¦é™ä½å…¬å¸/ç”¢æ¥­ç‰¹æœ‰çš„éç³»çµ±æ€§é¢¨éšªï¼›ç³»çµ±æ€§é¢¨éšªç„¡æ³•é åˆ†æ•£æ¶ˆé™¤ã€‚"
      },
      {
        qid: "INV-02", type: "choice",
        stem: "åœ¨å…¶ä»–æ¢ä»¶ç›¸åŒä¸‹ï¼Œå…©è³‡ç”¢çš„ç›¸é—œä¿‚æ•¸è¶Šæ¥è¿‘ -1ï¼Œä»£è¡¨ï¼Ÿ",
        choices: ["åˆ†æ•£æ•ˆæœè¶Šå·®", "åˆ†æ•£æ•ˆæœè¶Šå¥½", "å ±é…¬ä¸€å®šæ›´é«˜", "é¢¨éšªä¸€å®šç‚º 0"],
        answerIndex: 1,
        explain: "ç›¸é—œä¿‚æ•¸è¶Šä½ï¼Œçµ„åˆæ³¢å‹•è¶Šå¯èƒ½äº’ç›¸æŠµéŠ·ï¼Œåˆ†æ•£æ•ˆæœé€šå¸¸è¶Šå¥½ã€‚"
      },
      {
        qid: "INV-03", type: "choice",
        stem: "ä¸‹åˆ—å“ªå€‹æ•˜è¿°æœ€ç¬¦åˆã€ç³»çµ±æ€§é¢¨éšªã€ï¼Ÿ",
        choices: ["å–®ä¸€å…¬å¸çˆ†é›·", "æ•´é«”å¸‚å ´ä¸‹è·Œ", "æŸç”¢æ¥­å€‹åˆ¥äº‹ä»¶", "å€‹äººäº¤æ˜“å¤±èª¤"],
        answerIndex: 1,
        explain: "ç³»çµ±æ€§é¢¨éšªä¾†è‡ªå¸‚å ´/ç¸½é«”å› ç´ ï¼Œå½±éŸ¿å¤§å¤šæ•¸è³‡ç”¢ã€‚"
      },
      {
        qid: "INV-04", type: "cloze",
        stem: "ï¼ˆæŒ–ç©ºï¼‰é€éæŒæœ‰å¤šç¨®è³‡ç”¢ä¾†é™ä½é¢¨éšªçš„ä½œæ³•ç¨±ç‚ºï¼š________",
        answerText: "åˆ†æ•£æŠ•è³‡",
        explain: "åˆ†æ•£æŠ•è³‡ï¼ˆDiversificationï¼‰æ˜¯æŠ•è³‡å­¸æœ€æ ¸å¿ƒçš„é¢¨éšªç®¡ç†æ¦‚å¿µä¹‹ä¸€ã€‚"
      },
      {
        qid: "INV-05", type: "choice",
        stem: "è‹¥ä¸€é …æŠ•è³‡çš„é æœŸå ±é…¬æ›´é«˜ï¼ŒæŠ•è³‡å­¸å¸¸è¦‹çš„ç›´è¦ºæ˜¯ï¼Ÿ",
        choices: ["é¢¨éšªé€šå¸¸ä¹Ÿæ›´é«˜", "é¢¨éšªé€šå¸¸æ›´ä½", "é¢¨éšªèˆ‡å ±é…¬ç„¡é—œ", "ä¸€å®šæ²’æœ‰æ³¢å‹•"],
        answerIndex: 0,
        explain: "ä¸€èˆ¬æƒ…æ³ä¸‹ï¼Œè¼ƒé«˜é¢¨éšªè³‡ç”¢éœ€è¦è¼ƒé«˜é æœŸå ±é…¬ä½œç‚ºè£œå„Ÿã€‚"
      }
    ]
  },

  {
    moduleId: "FIN-01",
    title: "è²¡å‹™åˆ†æï½œé€Ÿè®€ 5 é¡Œ",
    keypoints: [
      "è²¡å‹™åˆ†æé€Ÿè®€é‡é»ï¼šæ¯”ç‡ã€æ–¹å‘ã€ï¼‹ã€ä»£è¡¨æ„ç¾©ã€ã€‚",
      "çŸ­æœŸå„Ÿå‚µï¼šæµå‹•æ¯”ç‡ï¼›æ§“æ¡¿ï¼šè² å‚µæ¯”ï¼›ç²åˆ©èƒ½åŠ›ï¼šROE/ROAã€‚",
      "åˆ¤è®€è¦æ­é…ï¼šç”¢æ¥­ç‰¹æ€§ã€è¶¨å‹¢ï¼ˆé€£çºŒæœŸé–“ï¼‰ã€ç¾é‡‘æµã€‚",
      "ï¼ˆMVP ç¤ºç¯„ï¼‰ä¹‹å¾Œå¯åŠ å…¥çœŸå¯¦è²¡å ±æƒ…å¢ƒé¡Œã€‚"
    ],
    questions: [
      {
        qid: "FIN-01", type: "choice",
        stem: "ã€æµå‹•æ¯”ç‡ã€ä¸»è¦ç”¨ä¾†è¡¡é‡ä»€éº¼èƒ½åŠ›ï¼Ÿ",
        choices: ["é•·æœŸæˆé•·èƒ½åŠ›", "çŸ­æœŸå„Ÿå‚µèƒ½åŠ›", "è‚¡æ±å ±é…¬èƒ½åŠ›", "å­˜è²¨å‘¨è½‰é€Ÿåº¦"],
        answerIndex: 1,
        explain: "æµå‹•æ¯”ç‡é€šå¸¸ç”¨ä¾†è§€å¯ŸçŸ­æœŸè³‡ç”¢æ˜¯å¦è¶³ä»¥æ”¯æ‡‰çŸ­æœŸè² å‚µã€‚"
      },
      {
        qid: "FIN-02", type: "choice",
        stem: "ROEï¼ˆè‚¡æ±æ¬Šç›Šå ±é…¬ç‡ï¼‰è¼ƒè²¼è¿‘è¡¡é‡ï¼Ÿ",
        choices: ["è‚¡æ±è³‡é‡‘ä½¿ç”¨æ•ˆç‡", "ç”¢å“æ¯›åˆ©ä¸€å®šæ›´é«˜", "ç¾é‡‘ä¸€å®šå¢åŠ ", "è² å‚µä¸€å®šä¸‹é™"],
        answerIndex: 0,
        explain: "ROEè¡¡é‡ä¼æ¥­é‹ç”¨è‚¡æ±æ¬Šç›Šå‰µé€ ç²åˆ©çš„æ•ˆç‡ï¼›ä»éœ€æ­é…ç¾é‡‘æµèˆ‡æ§“æ¡¿åˆ¤è®€ã€‚"
      },
      {
        qid: "FIN-03", type: "choice",
        stem: "è² å‚µæ¯”ä¸Šå‡ï¼Œæœ€ç›´æ¥å¯èƒ½ä»£è¡¨ï¼Ÿ",
        choices: ["æ§“æ¡¿æé«˜", "ä¸€å®šæ›´å®‰å…¨", "ä¸€å®šæ›´è³ºéŒ¢", "ä¸€å®šç¾é‡‘è®Šå¤š"],
        answerIndex: 0,
        explain: "è² å‚µæ¯”ä¸Šå‡é€šå¸¸è¡¨ç¤ºä½¿ç”¨è¼ƒå¤šè² å‚µè³‡é‡‘ï¼Œæ§“æ¡¿æé«˜ã€‚"
      },
      {
        qid: "FIN-04", type: "choice",
        stem: "å…¬å¸ ROE å¾ˆé«˜ï¼Œä½†ç‡Ÿé‹ç¾é‡‘æµåå¼±ï¼Œè¼ƒåˆç†çš„è­¦è¨Šæ˜¯ï¼Ÿ",
        choices: ["ç²åˆ©å“è³ªå¯èƒ½éœ€å†æª¢æŸ¥", "å…¬å¸ä¸€å®šæ˜¯æˆé•·è‚¡", "ä¸€å®šæ²’æœ‰è²¡å‹™é¢¨éšª", "è¡¨ç¤ºä¸éœ€è¦çœ‹ç¾é‡‘æµ"],
        answerIndex: 0,
        explain: "ç²åˆ©ä¸ç­‰æ–¼ç¾é‡‘ï¼Œéœ€æ­é…ç¾é‡‘æµèˆ‡æ§“æ¡¿ä¾†æºåˆ¤è®€ã€‚"
      },
      {
        qid: "FIN-05", type: "cloze",
        stem: "ï¼ˆæŒ–ç©ºï¼‰åŒä¸€å…¬å¸æ¯”ç‡åˆ¤è®€æ™‚ï¼Œæœ€é‡è¦çš„æ˜¯çœ‹é€£çºŒæœŸé–“çš„ ________ï¼ˆä¾‹å¦‚é€å­£/é€å¹´è®ŠåŒ–ï¼‰ã€‚",
        answerText: "è¶¨å‹¢",
        explain: "æ¯”ç‡è¦çœ‹è¶¨å‹¢èˆ‡çµæ§‹è®ŠåŒ–ï¼Œå–®ä¸€æ™‚é»å®¹æ˜“èª¤åˆ¤ã€‚"
      }
    ]
  },

  {
    moduleId: "LAW-01",
    title: "è­‰åˆ¸äº¤æ˜“æ³•è¦ï½œé€Ÿè®€ 5 é¡Œ",
    keypoints: [
      "æ³•è¦é€Ÿè®€é‡é»ï¼šåè©å®šç¾©ã€æ§‹æˆè¦ä»¶ã€è²¬ä»»ä¸»é«”èˆ‡ä¾‹å¤–ï¼ˆé—œéµå­—åè½‰ï¼‰ã€‚",
      "å…ˆæŠ“ã€èª°ï¼ˆä¸»é«”ï¼‰ã€ï¼‹ã€åšäº†ä»€éº¼ï¼ˆè¡Œç‚ºï¼‰ã€ï¼‹ã€è²¬ä»»/æ•ˆæœã€ã€‚",
      "æ•¸å­—é¡Œå»ºè­°ç”¨æŒ–ç©ºåè¦†åˆºæ¿€ï¼›ä¸Šç·šå‰å‹™å¿…ä¾æœ€æ–°ç‰ˆæ³•è¦æ ¡å°ã€‚",
      "ï¼ˆMVP ç¤ºç¯„ï¼‰æ­¤è™•é¡Œç›®ä»¥æ¦‚å¿µç‚ºä¸»ã€‚"
    ],
    questions: [
      {
        qid: "LAW-01", type: "choice",
        stem: "ä¸‹åˆ—ä½•è€…æœ€æ¥è¿‘ã€å…§ç·šäº¤æ˜“ã€çš„æ ¸å¿ƒæ¦‚å¿µï¼Ÿ",
        choices: ["ä½¿ç”¨å…¬é–‹è³‡è¨Šäº¤æ˜“", "åˆ©ç”¨æœªå…¬é–‹é‡å¤§æ¶ˆæ¯äº¤æ˜“", "é•·æœŸæŒæœ‰ä¸äº¤æ˜“", "åªç”¨æŠ€è¡“åˆ†æ"],
        answerIndex: 1,
        explain: "å…§ç·šäº¤æ˜“æ ¸å¿ƒåœ¨æ–¼åˆ©ç”¨æœªå…¬é–‹é‡å¤§è³‡è¨Šäº¤æ˜“ï¼Œç ´å£å¸‚å ´å…¬å¹³æ€§ã€‚"
      },
      {
        qid: "LAW-02", type: "choice",
        stem: "æ³•è¦é¡Œåœ¨åˆ¤æ–·è²¬ä»»æ™‚ï¼Œæœ€å„ªå…ˆè¦ç¢ºèªçš„æ˜¯ï¼Ÿ",
        choices: ["å¸‚å ´æ°£æ°›", "è¡Œç‚ºä¸»é«”èˆ‡æ§‹æˆè¦ä»¶", "è‚¡åƒ¹èµ°å‹¢", "åª’é«”å ±å°"],
        answerIndex: 1,
        explain: "å…ˆé–å®šã€èª°ã€èˆ‡ã€æ˜¯å¦ç¬¦åˆæ§‹æˆè¦ä»¶ã€ï¼Œå†è«‡è²¬ä»»èˆ‡è™•ç½°ã€‚"
      },
      {
        qid: "LAW-03", type: "cloze",
        stem: "ï¼ˆæŒ–ç©ºï¼‰æ³•è¦é¡ŒèƒŒèª¦æ¡†æ¶ï¼šèª°ï¼ˆ____ï¼‰ï¼‹åšäº†ä»€éº¼ï¼ˆè¡Œç‚ºï¼‰ï¼‹è²¬ä»»/æ•ˆæœã€‚",
        answerText: "ä¸»é«”",
        explain: "å…ˆæŠ“ä¸»é«”ï¼ˆèª°è² è²¬ï¼‰ï¼Œå†çœ‹è¡Œç‚ºèˆ‡è¦ä»¶ï¼Œæœ€å¾Œæ‰æ˜¯æ•ˆæœ/è²¬ä»»ã€‚"
      },
      {
        qid: "LAW-04", type: "choice",
        stem: "ä¸‹åˆ—å“ªä¸€é …æœ€èƒ½æå‡è­‰åˆ¸å¸‚å ´çš„ã€å…¬å¹³æ€§ã€ï¼Ÿ",
        choices: ["è®“å°‘æ•¸äººå…ˆçŸ¥é“æ¶ˆæ¯", "å¼·åŒ–è³‡è¨Šæ­éœ²èˆ‡äº¤æ˜“é€æ˜", "é™ä½æ­éœ²è¦æ±‚", "é¼“å‹µä¸æ­éœ²"],
        answerIndex: 1,
        explain: "è³‡è¨Šæ­éœ²èˆ‡é€æ˜åº¦æå‡ï¼Œæœ‰åŠ©é™ä½è³‡è¨Šä¸å°ç¨±ï¼Œæ”¹å–„å…¬å¹³æ€§ã€‚"
      },
      {
        qid: "LAW-05", type: "choice",
        stem: "è‹¥é¡Œç›®åœ¨è€ƒã€ä¾‹å¤–ã€ï¼Œæœ€å®¹æ˜“å¤±åˆ†çš„åŸå› é€šå¸¸æ˜¯ï¼Ÿ",
        choices: ["æ²’çœ‹æ¸…æ¥šé—œéµå­—", "ç®—è¡“å¤ªé›£", "é¡Œç›®å¤ªé•·å°±è·³é", "ä¸ç”¨è®€é¡Œå¹¹"],
        answerIndex: 0,
        explain: "æ³•è¦é¡Œå¸¸é é—œéµå­—åè½‰ï¼ˆä½†æ›¸/ä¾‹å¤–/é™¤å¤–ï¼‰ï¼Œè¦ç‰¹åˆ¥è­¦è¦ºã€‚"
      }
    ]
  }
];

    /**********************
     * 2) localStorage keys
     **********************/
    const LS = {
      user: "gao_user_v1",
      progress: "gao_progress_v1",
      wrongbook: "gao_wrongbook_v1"
    };

    /**********************
     * 3) App State
     **********************/
    const state = {
      userId: null,
      nickname: null,
      currentModuleId: MODULES[0].moduleId,
      currentQuestionIndex: 0,
      answeredMap: {}, // qid -> true
      liffReady: false
    };

    /**********************
     * 4) Helpers
     **********************/
    const $ = (id) => document.getElementById(id);
    const nowISO = () => new Date().toISOString();
    const clamp = (n,min,max)=>Math.max(min,Math.min(max,n));

    function toast(msg){
      const el = $("toast");
      el.textContent = msg;
      el.classList.add("show");
      setTimeout(()=>el.classList.remove("show"), 1800);
    }

    function loadJSON(key, fallback){
      try{
        const raw = localStorage.getItem(key);
        return raw ? JSON.parse(raw) : fallback;
      }catch(e){
        return fallback;
      }
    }
    function saveJSON(key, value){
      localStorage.setItem(key, JSON.stringify(value));
    }

    function getUser(){
      return loadJSON(LS.user, null);
    }
    function setUser(user){
      saveJSON(LS.user, user);
    }
    function getProgress(){
      // progress shape: { moduleId: { completedQids: [], updatedAt } }
      return loadJSON(LS.progress, {});
    }
    function setProgress(p){
      saveJSON(LS.progress, p);
    }
    function getWrongbook(){
      // wrongbook: { items: [ {qid,moduleId,stem,correct,chosen,explain,ts} ] }
      return loadJSON(LS.wrongbook, { items: [] });
    }
    function setWrongbook(w){
      saveJSON(LS.wrongbook, w);
    }

    function computeOverallProgress(){
      const progress = getProgress();
      let total = 0;
      let done = 0;

      for(const m of MODULES){
        total += m.questions.length;
        const rec = progress[m.moduleId];
        if(rec?.completedQids?.length){
          done += rec.completedQids.length;
        }
      }
      const pct = total ? Math.round((done/total)*100) : 0;
      return { total, done, pct: clamp(pct,0,100) };
    }

   function renderModuleList(){
  const box = $("moduleList");
  box.innerHTML = "";

  for(const m of MODULES){
    const div = document.createElement("div");
    div.className = "item";
    div.innerHTML = `
      <b>${m.title}</b>
      <div class="meta">é¡Œæ•¸ï¼š${m.questions.length}ï½œmoduleIdï¼š${m.moduleId}</div>
      <div class="btnrow" style="margin-top:10px;">
        <button class="secondary" data-start-module="${m.moduleId}">é–‹å§‹é€™ç§‘</button>
      </div>
    `;
    box.appendChild(div);
  }

  box.querySelectorAll("[data-start-module]").forEach(btn => {
    btn.addEventListener("click", () => {
      state.currentModuleId = btn.getAttribute("data-start-module");
      showView("viewSpeedread");
      renderSpeedread();
    });
  });
}

    /**********************
     * 5) LIFF init (å¯ç›´æ¥ä¸Šç·š)
     **********************/
    async function initLIFF(){
      // ä½ éœ€è¦å» LINE Developers å»º LIFF appï¼Œæ‹¿åˆ° liffId
      const LIFF_ID = "YOUR_LIFF_ID_HERE";

      try{
        if(!window.liff){
          throw new Error("LIFF SDK not loaded");
        }
        // è‹¥å°šæœªå¡« liffIdï¼Œå…ˆä»¥ demo æ¨¡å¼è·‘
        if(LIFF_ID === "YOUR_LIFF_ID_HERE"){
          state.userId = "demo-user";
          state.liffReady = false;
          return;
        }

        await liff.init({ liffId: LIFF_ID });
        state.liffReady = true;

        if(!liff.isLoggedIn()){
          liff.login(); // æœƒå°å›åŒä¸€é 
          return;
        }

        const profile = await liff.getProfile();
        state.userId = profile.userId;
      }catch(err){
        // æœ¬æ©Ÿé–‹å•Ÿæˆ–å¤±æ•— â†’ demo user
        state.userId = "demo-user";
        state.liffReady = false;
      }
    }

    /**********************
     * 6) View switching
     **********************/
    function showView(name){
      const views = ["viewOnboarding","viewMain","viewSpeedread","viewWrongbook"];
      for(const v of views) $(v).classList.add("hidden");
      $(name).classList.remove("hidden");
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    /**********************
     * 7) UI Rendering
     **********************/
    function renderTopbar(){
      const u = getUser();
      if(u){
        $("userPill").textContent = `${u.nickname} Â· ${u.userId === "demo-user" ? "Demo" : "LINE"}`;
        $("subline").textContent = u.userId === "demo-user"
          ? "æœ¬æ©Ÿ Demoï¼ˆuserId=demo-userï¼‰"
          : "LIFF å·²ç™»å…¥ï¼ˆä½¿ç”¨ LINE userIdï¼‰";
      }else{
        $("userPill").textContent = "æœªè¨­å®šæš±ç¨±";
        $("subline").textContent = "LIFF / localStorage";
      }
    }

    function renderDashboard(){
      const u = getUser();
      if(!u) return;

      $("welcomeText").textContent = `å—¨ï¼Œ${u.nickname}ï¼ä»Šå¤©ä¾†æŠŠé«˜æ¥­é€Ÿè®€æ¨é€²ä¸€é»é»ã€‚`;

      const pr = computeOverallProgress();
      $("progressBar").style.width = pr.pct + "%";
      $("progressText").textContent = `${pr.pct}%`;
      $("progressDetail").textContent = `å·²å®Œæˆ ${pr.done} / ${pr.total}`;

      $("debugInfo").textContent =
        `userId: ${u.userId}\n` +
        `nickname: ${u.nickname}\n` +
        `progress: ${pr.done}/${pr.total} (${pr.pct}%)\n` +
        `wrongbook items: ${getWrongbook().items.length}\n` +
        `mode: ${u.userId === "demo-user" ? "demo" : "liff"}`;

      renderModuleList();
    }

    function renderSpeedread(){
      const m = MODULES.find(x => x.moduleId === state.currentModuleId) || MODULES[0];
      $("srTitle").textContent = `é€Ÿè®€å·¥å…· Â· ${m.title}`;
      $("srKeypoints").innerHTML = `
        <ul style="margin:0; padding-left:18px; color:var(--text); line-height:1.6;">
          ${m.keypoints.map(k=>`<li>${k}</li>`).join("")}
        </ul>
      `;

      // load current module progress into state.answeredMap
      const progress = getProgress();
      const completed = new Set(progress[m.moduleId]?.completedQids || []);
      state.answeredMap = {};
      for(const qid of completed) state.answeredMap[qid] = true;

      // find next unanswered
      const idx = m.questions.findIndex(q => !state.answeredMap[q.qid]);
      state.currentQuestionIndex = idx === -1 ? m.questions.length - 1 : idx;

      renderQuestion();
    }
function renderQuestion(){
  const m = MODULES.find(x => x.moduleId === state.currentModuleId) || MODULES[0];
  const q = m.questions[state.currentQuestionIndex];
  const box = $("questionBox");
  box.innerHTML = "";

  if(!q){
    box.innerHTML = `<p class="mini">æ­¤ç§‘ç›®æ²’æœ‰é¡Œç›®ã€‚</p>`;
    return;
  }

  const doneAll = m.questions.every(qq => state.answeredMap[qq.qid]);
  if(doneAll){
    box.innerHTML = `
      <div class="q">
        <div class="qTitle">âœ… é€™ç§‘ 5 é¡Œå·²å®Œæˆï¼</div>
        <p class="mini">ä½ å¯ä»¥æŒ‰ã€Œé‡ä¾†ä¸€æ¬¡ã€é‡æ–°ç·´ï¼Œæˆ–å›ä¸»é çœ‹é€²åº¦ã€‚</p>
      </div>
    `;
    return;
  }

  const qWrap = document.createElement("div");
  qWrap.className = "q";
  qWrap.innerHTML = `
    <div class="qTitle">Q${state.currentQuestionIndex+1}. ${q.stem}</div>
    <div class="mini">ç­”éŒ¯æœƒåŠ å…¥éŒ¯é¡Œæœ¬ï¼Œä¸æœƒå¡é—œã€‚</div>
    <div id="interactive"></div>
    <div class="mini" id="explainBox" style="display:none;"></div>
  `;
  box.appendChild(qWrap);

  const interactive = qWrap.querySelector("#interactive");

  if(q.type === "cloze"){
    interactive.innerHTML = `
      <div style="margin-top:10px; display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
        <input id="clozeInput" placeholder="è¼¸å…¥ç­”æ¡ˆ" style="flex:1; min-width:180px;" />
        <button class="secondary" id="clozeSubmit">é€å‡º</button>
      </div>
    `;
    const submit = qWrap.querySelector("#clozeSubmit");
    submit.addEventListener("click", () => {
      const inp = qWrap.querySelector("#clozeInput");
      const userText = (inp.value || "").trim();
      onAnswerCloze(userText, qWrap);
    });
    qWrap.querySelector("#clozeInput").addEventListener("keydown", (e)=>{
      if(e.key === "Enter") submit.click();
    });
  }else{
    interactive.innerHTML = `<div class="choices" id="choices"></div>`;
    const choices = qWrap.querySelector("#choices");
    q.choices.forEach((c, i) => {
      const btn = document.createElement("button");
      btn.className = "choice";
      btn.textContent = c;
      btn.onclick = () => onAnswer(i, btn, qWrap);
      choices.appendChild(btn);
    });
  }
}
    function renderWrongbook(){
      const w = getWrongbook();
      const list = $("wrongList");
      list.innerHTML = "";

      if(!w.items.length){
        $("wrongEmpty").classList.remove("hidden");
        return;
      }
      $("wrongEmpty").classList.add("hidden");

      w.items.slice().reverse().forEach(it => {
        const div = document.createElement("div");
        div.className = "item";
        div.innerHTML = `
          <b>${it.stem}</b>
          <div class="meta">moduleIdï¼š${it.moduleId}ï½œæ™‚é–“ï¼š${new Date(it.ts).toLocaleString()}</div>
          <div class="ans">âœ… æ­£è§£ï¼š${it.correct}</div>
          <div class="ans" style="color:#b84b4b">âŒ ä½ çš„ç­”æ¡ˆï¼š${it.chosen}</div>
          <div class="mini">${it.explain || ""}</div>
        `;
        list.appendChild(div);
      });
    }

    /**********************
     * 8) Actions
     **********************/
    function ensureUserOrOnboard(){
      const u = getUser();
      renderTopbar();
      if(!u){
        showView("viewOnboarding");
        return false;
      }
      showView("viewMain");
      renderDashboard();
      return true;
    }

    function saveNickname(){
      const nick = $("nicknameInput").value.trim();
      if(!nick){
        toast("è«‹è¼¸å…¥æš±ç¨±");
        return;
      }
      const user = { userId: state.userId || "demo-user", nickname: nick, createdAt: nowISO() };
      setUser(user);
      toast("å·²å»ºç«‹ä½¿ç”¨è€…è³‡æ–™ âœ…");
      $("nicknameInput").value = "";
      ensureUserOrOnboard();
    }

    function changeNickname(){
      const u = getUser();
      if(!u) return;
      const nick = prompt("è¼¸å…¥æ–°çš„æš±ç¨±ï¼ˆæœ€å¤š 16 å­—ï¼‰", u.nickname);
      if(!nick) return;
      u.nickname = nick.slice(0,16).trim() || u.nickname;
      setUser(u);
      toast("æš±ç¨±å·²æ›´æ–°");
      renderTopbar();
      renderDashboard();
    }

    function resetAll(){
      localStorage.removeItem(LS.user);
      localStorage.removeItem(LS.progress);
      localStorage.removeItem(LS.wrongbook);
      toast("å·²æ¸…é™¤æ‰€æœ‰è³‡æ–™");
      renderTopbar();
      showView("viewOnboarding");
    }

    function onAnswer(chosenIndex, clickedBtn, qWrap){
      const m = MODULES.find(x => x.moduleId === state.currentModuleId) || MODULES[0];
      const q = m.questions[state.currentQuestionIndex];
      if(!q) return;

      // disable all choices after answer
      const btns = qWrap.querySelectorAll(".choice");
      btns.forEach(b => b.disabled = true);

      const correctIndex = q.answerIndex;
      const explainBox = qWrap.querySelector("#explainBox");
      explainBox.style.display = "block";
      explainBox.textContent = "è§£æï¼š" + (q.explain || "");

      // style correct/incorrect
      btns.forEach((b, idx) => {
        if(idx === correctIndex) b.classList.add("ok");
        if(idx === chosenIndex && chosenIndex !== correctIndex) b.classList.add("bad");
      });

      // record progress when correct
      if(chosenIndex === correctIndex){
        const prog = getProgress();
        prog[m.moduleId] = prog[m.moduleId] || { completedQids: [], updatedAt: nowISO() };
        if(!prog[m.moduleId].completedQids.includes(q.qid)){
          prog[m.moduleId].completedQids.push(q.qid);
        }
        prog[m.moduleId].updatedAt = nowISO();
        setProgress(prog);
        state.answeredMap[q.qid] = true;
        toast("ç­”å° âœ… å·²æ›´æ–°é€²åº¦");
      }else{
        // add wrongbook item (dedupe by qid)
        const wb = getWrongbook();
        const exists = wb.items.some(it => it.qid === q.qid && it.moduleId === m.moduleId);
        if(!exists){
          wb.items.push({
            qid: q.qid,
            moduleId: m.moduleId,
            stem: q.stem,
            correct: q.choices[correctIndex],
            chosen: q.choices[chosenIndex],
            explain: q.explain || "",
            ts: Date.now()
          });
          setWrongbook(wb);
        }
        toast("ç­”éŒ¯ âŒ å·²åŠ å…¥éŒ¯é¡Œæœ¬");
      }

      // refresh dashboard pill (counts)
      renderTopbar();
    }
function onAnswerCloze(userText, qWrap){
  const m = MODULES.find(x => x.moduleId === state.currentModuleId) || MODULES[0];
  const q = m.questions[state.currentQuestionIndex];
  if(!q) return;

  const explainBox = qWrap.querySelector("#explainBox");
  const inp = qWrap.querySelector("#clozeInput");
  const btn = qWrap.querySelector("#clozeSubmit");

  const normalize = (s) => (s || "").trim().replace(/\s+/g, "");
  const correct = normalize(q.answerText);
  const chosen = normalize(userText);

  if(!chosen){
    toast("è«‹å…ˆè¼¸å…¥ç­”æ¡ˆ");
    return;
  }

  if(inp) inp.disabled = true;
  if(btn) btn.disabled = true;

  explainBox.style.display = "block";
  explainBox.textContent = "è§£æï¼š" + (q.explain || "");

  if(chosen === correct){
    const prog = getProgress();
    prog[m.moduleId] = prog[m.moduleId] || { completedQids: [], updatedAt: nowISO() };
    if(!prog[m.moduleId].completedQids.includes(q.qid)){
      prog[m.moduleId].completedQids.push(q.qid);
    }
    prog[m.moduleId].updatedAt = nowISO();
    setProgress(prog);
    state.answeredMap[q.qid] = true;
    toast("ç­”å° âœ… å·²æ›´æ–°é€²åº¦");

    if(inp){
      inp.style.borderColor = "rgba(112,201,168,.9)";
      inp.style.background = "rgba(112,201,168,.12)";
    }
  } else {
    const wb = getWrongbook();
    const exists = wb.items.some(it => it.qid === q.qid && it.moduleId === m.moduleId);
    if(!exists){
      wb.items.push({
        qid: q.qid,
        moduleId: m.moduleId,
        stem: q.stem,
        correct: q.answerText,
        chosen: userText,
        explain: q.explain || "",
        ts: Date.now()
      });
      setWrongbook(wb);
    }
    toast("ç­”éŒ¯ âŒ å·²åŠ å…¥éŒ¯é¡Œæœ¬");

    if(inp){
      inp.style.borderColor = "rgba(224,122,122,.85)";
      inp.style.background = "rgba(224,122,122,.10)";
    }
  }

  renderTopbar();
}
    function nextQuestion(){
      const m = MODULES.find(x => x.moduleId === state.currentModuleId) || MODULES[0];

      // find next unanswered from current+1
      for(let step=1; step<=m.questions.length; step++){
        const idx = (state.currentQuestionIndex + step) % m.questions.length;
        if(!state.answeredMap[m.questions[idx].qid]){
          state.currentQuestionIndex = idx;
          renderQuestion();
          return;
        }
      }
      // all done
      renderQuestion();
    }

    function restartModule(){
      // reset progress for this module only
      const m = MODULES.find(x => x.moduleId === state.currentModuleId) || MODULES[0];
      const prog = getProgress();
      if(prog[m.moduleId]){
        prog[m.moduleId].completedQids = [];
        prog[m.moduleId].updatedAt = nowISO();
        setProgress(prog);
      }
      // keep wrongbook (ä¸æ¸…)
      toast("å·²é‡ç½®æœ¬å–®å…ƒé€²åº¦");
      renderSpeedread();
    }

    function clearWrongbook(){
      setWrongbook({ items: [] });
      toast("éŒ¯é¡Œæœ¬å·²æ¸…ç©º");
      renderWrongbook();
      renderTopbar();
    }

    /**********************
     * 9) Wire Events
     **********************/
    function wire(){
      $("btnSaveNickname").onclick = saveNickname;
      $("btnDemoReset").onclick = resetAll;

      $("btnGoSpeedread").onclick = () => { showView("viewSpeedread"); renderSpeedread(); };
      $("btnGoWrongbook").onclick = () => { showView("viewWrongbook"); renderWrongbook(); };

      $("btnBackHome1").onclick = () => { showView("viewMain"); renderDashboard(); };
      $("btnBackHome2").onclick = () => { showView("viewMain"); renderDashboard(); };

      $("btnNextQuestion").onclick = nextQuestion;
      $("btnRestartModule").onclick = restartModule;

      $("btnChangeNick").onclick = changeNickname;
      $("btnResetAll").onclick = resetAll;

      $("btnClearWrongbook").onclick = clearWrongbook;

      // Enter key save nickname
      $("nicknameInput").addEventListener("keydown", (e)=>{
        if(e.key === "Enter") saveNickname();
      });
    }

    /**********************
     * 10) Boot
     **********************/
    (async function boot(){
      wire();
      await initLIFF();

      // If user exists but userId mismatch, adopt current userId (é¿å…æ›æ‰‹æ©Ÿ/é‡æ–°ç™»å…¥é€ æˆåˆ†è£‚)
      const u = getUser();
      if(u && state.userId && u.userId !== state.userId){
        u.userId = state.userId;
        setUser(u);
      }

      renderTopbar();

      if(u){
        showView("viewMain");
        renderDashboard();
      }else{
        showView("viewOnboarding");
      }
    })();
  </script>
</body>
</html>